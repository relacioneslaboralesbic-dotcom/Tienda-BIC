<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Turnos</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <div class="banner">
    <img src="Banner.jpg" alt="Banner" onerror="this.style.display='none'">
  </div>

  <!-- Formulario de Solicitud -->
  <div class="container">
    <form id="requestForm">
      <input type="text" id="clientName" placeholder="Nombre completo" required>
      <input type="text" id="employeeNumber" placeholder="Número de empleado" required>
      <button type="submit">Solicitar Turno</button>
    </form>
  </div>

  <!-- Login Admin -->
  <div class="container" id="adminLogin">
    <input type="password" id="adminPassword" placeholder="Contraseña de administrador">
    <button id="adminLoginBtn">Entrar</button>
  </div>

  <!-- Panel Admin -->
  <div class="container hidden" id="adminContent">
    <button id="callNextBtn">Llamar Siguiente Turno</button>
    <button id="cancelAllBtn">Cancelar Todos los Turnos</button>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal hidden">
    <div class="modal-content">
      <span id="closeModal">&times;</span>
      <h2 id="modalTitle"></h2>
      <p id="modalMessage"></p>
      <button id="downloadTicketBtn" class="hidden">Descargar Ticket</button>
    </div>
  </div>

  <!-- Ticket -->
  <div id="ticket" class="ticket hidden">
    <img src="logo.jpg" alt="Logo" onerror="this.style.display='none'">
    <h1 id="ticketNumber"></h1>
    <p id="ticketName"></p>
    <p id="ticketDate"></p>
  </div>

  <!-- Firebase y App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp, getDocs, doc,
      query, orderBy, limit, updateDoc, where, onSnapshot, runTransaction, writeBatch, getDoc
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

    // Configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAHzI1vbr-dBsrYRTcXGHLvg4HxVctP4Gg",
      authDomain: "app-tickets.firebaseapp.com",
      projectId: "app-tickets",
      storageBucket: "app-tickets.firebasestorage.app",
      messagingSenderId: "527311089363",
      appId: "1:527311089363:web:77d52904836fe53f18b05f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const appId = "appId123"; 
    const requestForm = document.getElementById('requestForm');
    const clientNameInput = document.getElementById('clientName');
    const employeeNumberInput = document.getElementById('employeeNumber');
    const adminPasswordInput = document.getElementById('adminPassword');
    const adminLoginBtn = document.getElementById('adminLoginBtn');
    const adminLogin = document.getElementById('adminLogin');
    const adminContent = document.getElementById('adminContent');
    const callNextBtn = document.getElementById('callNextBtn');
    const cancelAllBtn = document.getElementById('cancelAllBtn');
    const modal = document.getElementById('modal');
    const closeModalBtn = document.getElementById('closeModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const downloadTicketBtn = document.getElementById('downloadTicketBtn');
    const ticket = document.getElementById('ticket');
    const ticketNumber = document.getElementById('ticketNumber');
    const ticketName = document.getElementById('ticketName');
    const ticketDate = document.getElementById('ticketDate');

    let lastGeneratedTurn = null;
    let currentClientDetails = null;
    let isAuthReady = false;

    const countersRef = doc(db, 'artifacts', appId, 'public', 'data', 'Counters', 'turnCounter');

    // Formulario cliente
    requestForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!isAuthReady) {
        showModal('Error','La aplicación no está lista.', false);
        return;
      }
      try {
        const clientName = clientNameInput.value.trim();
        const employeeNumber = employeeNumberInput.value.trim();
        if (!clientName || !employeeNumber) {
          showModal('Error','Por favor, introduce tu nombre y número de empleado.', false);
          return;
        }

        const localDateString = new Date().toLocaleString();
        let createdDocRef = null;

        await runTransaction(db, async (transaction) => {
          const counterSnap = await transaction.get(countersRef);
          let nextNumber = 1;
          if (counterSnap.exists()) {
            const data = counterSnap.data();
            nextNumber = (data.lastNumber || 0) + 1;
          }
          transaction.set(countersRef, { lastNumber: nextNumber }, { merge: true });

          const turnsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'Turnos');
          const newTurnRef = doc(turnsCollection);
          const newTurn = {
            number: nextNumber,
            clientName,
            employeeNumber,
            status: 'pending',
            createdAtLocal: localDateString,
            timestamp: serverTimestamp()
          };
          transaction.set(newTurnRef, newTurn);
          createdDocRef = newTurnRef;
        });

        const createdSnap = await getDoc(createdDocRef);
        const createdData = createdSnap.exists() ? createdSnap.data() : null;
        lastGeneratedTurn = createdData ? { ...createdData, id: createdDocRef.id } : null;
        currentClientDetails = { name: clientName, empNum: employeeNumber };

        showModal('Turno Solicitado', `Tu número de turno es el ${formatTurnNumber(lastGeneratedTurn.number)}.`, true);
        clientNameInput.value = '';
        employeeNumberInput.value = '';

      } catch (error) {
        console.error("Error al solicitar el turno: ", error);
        showModal('Error', 'Hubo un problema al solicitar el turno. Por favor, inténtalo de nuevo.', false);
      }
    });

    // Login Admin (se mantiene con password en cliente como pediste)
    const ADMIN_PASSWORD = "bic-admin";
    adminLoginBtn.addEventListener('click', () => {
      const enteredPassword = adminPasswordInput.value.trim();
      if (enteredPassword === ADMIN_PASSWORD) {
        adminLogin.classList.add('hidden');
        adminContent.classList.remove('hidden');
        showModal('Acceso Concedido', 'Has ingresado al panel de administración.', false);
      } else {
        showModal('Acceso Denegado', 'La contraseña es incorrecta.', false);
      }
    });

    // Llamar siguiente
    callNextBtn.addEventListener('click', async () => {
      if (!isAuthReady) {
        showModal('Error', 'La aplicación no está lista.', false);
        return;
      }
      try {
        const turnsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'Turnos');
        const pendingQuery = query(turnsCollection, where('status', '==', 'pending'), orderBy('number', 'asc'), limit(1));
        const pendingSnap = await getDocs(pendingQuery);

        if (pendingSnap.empty) {
          showModal('Sin Turnos Pendientes', 'No hay más turnos en la cola.', false);
          return;
        }
        const nextDoc = pendingSnap.docs[0];
        await updateDoc(nextDoc.ref, { status: 'called', calledAt: serverTimestamp() });
        showModal('Turno Llamado', `El turno ${formatTurnNumber(nextDoc.data().number)} ha sido llamado.`, false);
      } catch (error) {
        console.error("Error al llamar el siguiente turno:", error);
        showModal('Error', 'Hubo un problema al llamar el siguiente turno.', false);
      }
    });

    // Cancelar todos
    async function deleteAllTurns() {
      try {
        const turnsRef = collection(db, 'artifacts', appId, 'public', 'data', 'Turnos');
        const snapshot = await getDocs(turnsRef);
        const docs = snapshot.docs.slice();
        while (docs.length) {
          const batch = writeBatch(db);
          const chunk = docs.splice(0, 400);
          chunk.forEach(docSnap => batch.delete(docSnap.ref));
          await batch.commit();
        }
        showModal('Turnos Cancelados', 'Todos los turnos han sido cancelados.', false);
      } catch (err) {
        console.error(err);
        showModal('Error', 'No se pudieron cancelar todos los turnos.', false);
      }
    }
    cancelAllBtn.addEventListener('click', deleteAllTurns);

    // Modal
    function showModal(title, message, showDownload = false) {
      modalTitle.textContent = title;
      modalMessage.textContent = message;
      downloadTicketBtn.classList.toggle('hidden', !showDownload);
      modal.classList.remove('hidden');
    }
    function closeModal() {
      modal.classList.add('hidden');
    }
    closeModalBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    // Descargar ticket
    downloadTicketBtn.addEventListener('click', async () => {
      if (!lastGeneratedTurn) return;
      let dateStr = lastGeneratedTurn.timestamp && lastGeneratedTurn.timestamp.toDate
        ? lastGeneratedTurn.timestamp.toDate().toLocaleString()
        : (lastGeneratedTurn.createdAtLocal || new Date().toLocaleString());

      generateTicketImage(lastGeneratedTurn.number, lastGeneratedTurn.clientName, dateStr);
      closeModal();
    });

    // Ticket
    async function generateTicketImage(number, clientName, dateStr) {
      ticketNumber.textContent = `Turno ${formatTurnNumber(number)}`;
      ticketName.textContent = clientName;
      ticketDate.textContent = dateStr;

      ticket.classList.remove('hidden');
      await new Promise(r => setTimeout(r, 500));

      try {
        const canvas = await html2canvas(ticket, { scale: 2 });
        const link = document.createElement('a');
        link.download = `ticket_${number}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      } catch (err) {
        console.error("Error al generar el ticket:", err);
        showModal('Error', 'No se pudo generar el ticket. Inténtalo de nuevo.', false);
      } finally {
        ticket.classList.add('hidden');
      }
    }

    function formatTurnNumber(num) {
      return num.toString().padStart(3, '0');
    }

    isAuthReady = true;
  </script>
</body>
</html>

</html>

