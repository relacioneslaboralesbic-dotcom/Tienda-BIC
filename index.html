<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tiendita BIC - Sistema de Turnos</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen">

  <div class="bg-white shadow-lg rounded-2xl p-6 w-full max-w-md">
    <h1 class="text-2xl font-bold text-center mb-6">ðŸŽ« Sistema de Turnos</h1>

    <!-- Formulario de turnos -->
    <form id="turnForm" class="mb-4 space-y-4">
      <input type="text" id="clientName" placeholder="Nombre del cliente"
        class="w-full border rounded p-2" required>
      <input type="text" id="employeeNumber" placeholder="NÃºmero de empleado"
        class="w-full border rounded p-2" required>
      <button type="submit"
        class="w-full bg-blue-500 text-white rounded p-2 hover:bg-blue-600">Generar Turno</button>
    </form>

    <!-- Botones de control -->
    <div class="flex space-x-2 mb-4">
      <button id="nextTurn"
        class="flex-1 bg-green-500 text-white rounded p-2 hover:bg-green-600">Siguiente</button>
      <button id="cancelAll"
        class="flex-1 bg-red-500 text-white rounded p-2 hover:bg-red-600">Cancelar Todos</button>
    </div>

    <!-- Display de turnos -->
    <div id="turnDisplay" class="space-y-2"></div>
  </div>

  <!-- Firebase + lÃ³gica -->
  <script type="module">
    // Importa Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      updateDoc,
      deleteDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    // ðŸ”¹ ConfiguraciÃ³n de Firebase (la tuya)
    const firebaseConfig = {
      apiKey: "AIzaSyDUwf0DHEN492RL5CHHRXiQ5mm96Gsztco",
      authDomain: "tiendita-bic-v2.firebaseapp.com",
      projectId: "tiendita-bic-v2",
      storageBucket: "tiendita-bic-v2.firebasestorage.app",
      messagingSenderId: "167484928309",
      appId: "1:167484928309:web:eb6965fa45825b3b091c7c",
      measurementId: "G-W59ZDBFN97"
    };

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    // Referencia a la colecciÃ³n "turnos"
    const turnosRef = collection(db, "turnos");

    // ========================
    // Funciones principales
    // ========================

    // Render de los turnos
    function renderTurns(turns) {
      const display = document.getElementById("turnDisplay");
      display.innerHTML = "";
      if (turns.length === 0) {
        display.innerHTML = "<p class='text-gray-500 text-center'>No hay turnos</p>";
        return;
      }
      turns.forEach(t => {
        const div = document.createElement("div");
        div.className = `p-3 rounded shadow ${t.status === "called" ? "bg-green-100" : "bg-gray-100"}`;
        div.innerText = `Turno #${t.number} - ${t.clientName} (Empleado: ${t.employeeNumber}) [${t.status}]`;
        display.appendChild(div);
      });
    }

    // Escucha en tiempo real a los turnos
    onSnapshot(turnosRef, snapshot => {
      const turns = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // Ordenar por timestamp
      turns.sort((a, b) => a.timestamp - b.timestamp);
      renderTurns(turns);
    });

    // ========================
    // Eventos
    // ========================

    // Crear turno
    document.getElementById("turnForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const clientName = document.getElementById("clientName").value;
      const employeeNumber = document.getElementById("employeeNumber").value;

      // Generar nÃºmero consecutivo (timestamp + random)
      const newNumber = Math.floor(Math.random() * 9000) + 1000;

      await addDoc(turnosRef, {
        number: newNumber,
        clientName,
        employeeNumber,
        status: "pending",
        timestamp: Date.now()
      });

      e.target.reset();
    });

    // Siguiente turno
    document.getElementById("nextTurn").addEventListener("click", async () => {
      onSnapshot(turnosRef, async snapshot => {
        const pending = snapshot.docs.find(doc => doc.data().status === "pending");
        if (pending) {
          await updateDoc(doc.ref, { status: "called" });
        } else {
          alert("No hay turnos pendientes");
        }
      });
    });

    // Cancelar todos
    document.getElementById("cancelAll").addEventListener("click", async () => {
      onSnapshot(turnosRef, async snapshot => {
        snapshot.docs.forEach(async d => {
          await deleteDoc(doc(db, "turnos", d.id));
        });
      });
    });
  </script>
</body>
</html>

